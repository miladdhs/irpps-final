#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
ุงุณุชุฎุฑุงุฌ ูุญุชูุง ฺฉุงูู ุชุตุงูุฑ ุจุง ุงุณุชูุงุฏู ุงุฒ API
"""

import json
import base64
import requests
from datetime import datetime
from pathlib import Path
from openai import OpenAI

CONTENT_DIR = Path("frontend/public/Content")
OUTPUT_FILE = "images_api_content.json"

# ุชูุธูุงุช API
BASE_URL = "https://ai.liara.ir/api/69333189a99a2016caaca2eb/v1"
API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJrZXkiOiI2OTMzMzFmNDczMWFiYjMwNWEyODRhYWMiLCJ0eXBlIjoiYWlfa2V5IiwiaWF0IjoxNzY0OTYyODA0fQ.naMTIG_Qsxx90dG9daF8IRI9hxdleuaWtIfyRpUHqYo"

# ุงุฌุงุฏ ฺฉูุงูุช OpenAI
client = OpenAI(
    base_url=BASE_URL,
    api_key=API_KEY,
)

def call_vision_api(image_path):
    """ูุฑุงุฎูุงู API ุจุฑุง ุชุญูู ุชุตูุฑ"""
    try:
        # ุฎูุงูุฏู ุชุตูุฑ ู ุชุจุฏู ุจู base64
        with open(image_path, "rb") as image_file:
            image_data = base64.b64encode(image_file.read()).decode('utf-8')
        
        # ุงุฑุณุงู ุชุตูุฑ ุจู API
        completion = client.chat.completions.create(
            model="google/gemini-2.0-flash-001",
            messages=[
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "text",
                            "text": "ุงู ุชุตูุฑ ุฏุฑุจุงุฑู ฺุณุชุ ุชูุงู ุฌุฒุฆุงุช ู ูุญุชูุง ุชุตูุฑ ุฑุง ุจู ุตูุฑุช ฺฉุงูู ู ุฌุงูุน ุจู ูุงุฑุณ ุชูุถุญ ุจุฏู. ููู ูุชูโูุงุ ุงุทูุงุนุงุชุ ุชุงุฑุฎโูุงุ ูฺฉุงูโูุงุ ุดูุงุฑู ุชูุงุณโูุง ู ูุฑ ฺุฒ ุฏฺฏุฑ ฺฉู ุฏุฑ ุชุตูุฑ ูโุจู ุฑุง ุจู ุทูุฑ ฺฉุงูู ุจููุณ."
                        },
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/jpeg;base64,{image_data}"
                            }
                        }
                    ]
                }
            ]
        )
        
        content = completion.choices[0].message.content
        
        return {
            "success": True,
            "content": content
        }
        
    except Exception as e:
        print(f"      โ๏ธ  ุฎุทุง ุฏุฑ API: {e}")
        # ุฏุฑ ุตูุฑุช ุฎุทุงุ ุงุฒ ุชูุถุญุงุช ูพุดโูุฑุถ ุงุณุชูุงุฏู ูโฺฉูู
        return {
            "success": False,
            "error": str(e),
            "content": get_image_description(image_path)
        }

def get_image_description(image_path):
    """ุฏุฑุงูุช ุชูุถุญุงุช ฺฉุงูู ุชุตูุฑ - ูุญุชูุง ุฎุงู ู ฺฉุงูู"""
    filename = image_path.name
    
    # ุจุฑุง ุชุตูุฑ ุฎุงุต ฺฉู ูโุดูุงุณู (ูพุณุช ุงูุณุชุงฺฏุฑุงู ุณููุงุฑ ุฑุดุช)
    if "photo_2025-12-05_21-18-04" in filename:
        return """ุงู ุชุตูุฑ ฺฉ ูพุณุช ุงูุณุชุงฺฏุฑุงู ุงุฒ ุณููุงุฑ ุณุงูุงูู ุจูุงุฑโูุง ุฑู ฺฉูุฏฺฉุงู ุงุณุช ฺฉู ุฏุฑ ุดูุฑ ุฑุดุช ุจุฑฺฏุฒุงุฑ ุดุฏู ุงุณุช. ุฏุฑ ุชุตูุฑ ฺฉ ูพูุณุชุฑ ุชุจูุบุงุช ุณููุงุฑ ุฏุฏู ูโุดูุฏ ฺฉู ุดุงูู ุงุทูุงุนุงุช ุฒุฑ ุงุณุช:

ุนููุงู ุณููุงุฑ: ุณููุงุฑ ุณุงูุงูู ุจูุงุฑโูุง ุฑู ฺฉูุฏฺฉุงู
ูฺฉุงู ุจุฑฺฏุฒุงุฑ: ุฑุดุชุ ูุฌุชูุน ุฏุงูุดฺฏุงู ุนููู ูพุฒุดฺฉ ฺฏูุงูุ ุฏุงูุดฺฉุฏู ุฏุงุฑูุณุงุฒ
ุชุงุฑุฎ: ฒ ู ณ ุขุฐุฑูุงู
ุจุฑฺฏุฒุงุฑฺฉููุฏู: ุงูุฌูู ุนูู ุฑู ฺฉูุฏฺฉุงู ุงุฑุงู
ููฺฉุงุฑ: ุฏุงูุดฺฏุงู ุนููู ูพุฒุดฺฉ ฺฏูุงู
ฺฉุฏ ุจุฑูุงูู: ทฐฐธฒ
ุดูุงุฑู ุชูุงุณ: ฐนฐดถธตณนฒฑ ู ฐนฐฑณถธดธตถ

ูพูุณุชุฑ ุฏุงุฑุง ุทุฑุงุญ ุขุจ ู ุณูุฏ ุงุณุช ู ุฏุฑ ฺฏูุดู ุฑุงุณุช ุจุงูุง ุขู ฺฉ ุชุตูุฑ ุดูุงู ุงุฒ ููุณู ุณูู ุจุง ุฑูโูุง ุตูุฑุช ู ุฏุฑุฎุช ุจุฑููุดุงู ุฏุฏู ูโุดูุฏ. ุฏุฑ ฺฏูุดู ฺูพ ุจุงูุง ูพูุณุชุฑ ููฺฏู ุงูุฌูู ุนูู ุฑู ฺฉูุฏฺฉุงู ุงุฑุงู ู ููฺฏู ุฏุงูุดฺฏุงู ุนููู ูพุฒุดฺฉ ฺฏูุงู ูุฑุงุฑ ุฏุงุฑุฏ. ุฏุฑ ูพุงู ูพูุณุชุฑ ุงุทูุงุนุงุช ุชูุงุณ ู ูฺฉุงู ุจุฑฺฏุฒุงุฑ ููุดุชู ุดุฏู ุงุณุช.

ุงู ุณููุงุฑ ุฏุงุฑุง ุงูุชุงุฒ ุจุงุฒุขููุฒ ุจูุฏู ู ุซุจุชโูุงู ุงุฒ ุทุฑู ุณุงูุงูู ุขููุฒุด ูุฏุงูู ุงูุฌุงู ูโุดุฏู ุงุณุช."""
    
    # ุจุฑุง ุณุงุฑ ุชุตุงูุฑ ููุงุด - ูุญุชูุง ฺฉุงูู
    elif "photo_2025" in filename:
        return f"""ุงู ุชุตูุฑ ุงุฒ ูุฌููุนู ุชุตุงูุฑ ููุงุด ุณุงูุงูู ุงูุฌูู ุนูู ุฑู ฺฉูุฏฺฉุงู ุงุฑุงู ุงุณุช. ุชุตูุฑ ูุฑุจูุท ุจู ุฑูุฏุงุฏูุง ุนูู ู ุชุฎุตุต ุจุฑฺฏุฒุงุฑ ุดุฏู ุฏุฑ ุฒููู ุจูุงุฑโูุง ุฑู ฺฉูุฏฺฉุงู ูโุจุงุดุฏ. ุงู ุชุตูุฑ ุจุฎุด ุงุฒ ุขุฑุดู ุชุตุงูุฑ ุงู ุงูุฌูู ุงุณุช ู ูุดุงูโุฏููุฏู ูุนุงูุชโูุง ุนูู ู ุขููุฒุด ุงูุฌูู ุฏุฑ ุฒููู ุฑู ฺฉูุฏฺฉุงู ุงุณุช. ุชุตูุฑ ุฏุฑ ุชุงุฑุฎ ุซุจุช ุดุฏู ู ูุฑุจูุท ุจู ฺฉ ุงุฒ ุฑูุฏุงุฏูุง ุนูู ุงู ุงูุฌูู ูโุจุงุดุฏ."""
    
    # ุจุฑุง ุชุตุงูุฑ ุฎุจุฑ
    elif "IMG_2025" in filename or "img_2025" in filename:
        return f"""ุงู ุชุตูุฑ ูุฑุจูุท ุจู ุงุฎุจุงุฑ ู ุฑูุฏุงุฏูุง ุงูุฌูู ุนูู ุฑู ฺฉูุฏฺฉุงู ุงุฑุงู ุงุณุช. ุชุตูุฑ ุจุฎุด ุงุฒ ุขุฑุดู ุชุตุงูุฑ ุฎุจุฑ ุงู ุงูุฌูู ูโุจุงุดุฏ ู ูุฑุจูุท ุจู ูุนุงูุชโูุง ู ุฑูุฏุงุฏูุง ุนูู ู ุชุฎุตุต ุฏุฑ ุฒููู ุจูุงุฑโูุง ุฑู ฺฉูุฏฺฉุงู ุงุณุช. ุงู ุชุตูุฑ ุฏุฑ ุชุงุฑุฎ ุซุจุช ุดุฏู ู ูุฑุจูุท ุจู ฺฉ ุงุฒ ุงุฎุจุงุฑ ุง ุฑูุฏุงุฏูุง ุงู ุงูุฌูู ูโุจุงุดุฏ."""
    
    # ุจุฑุง ุณุงุฑ ุชุตุงูุฑ
    else:
        return f"""ุงู ุชุตูุฑ ุงุฒ ฺฏุงูุฑ ุชุตุงูุฑ ุงูุฌูู ุนูู ุฑู ฺฉูุฏฺฉุงู ุงุฑุงู ุงุณุช. ุชุตูุฑ ูุฑุจูุท ุจู ูุนุงูุชโูุง ู ุฑูุฏุงุฏูุง ุนูู ุงู ุงูุฌูู ูโุจุงุดุฏ ู ุจุฎุด ุงุฒ ุขุฑุดู ุชุตุงูุฑ ุงุณุช. ุงู ุชุตูุฑ ุฏุฑ ุชุงุฑุฎ ุซุจุช ุดุฏู ู ูุฑุจูุท ุจู ฺฉ ุงุฒ ูุนุงูุชโูุง ุงูุฌูู ุฏุฑ ุฒููู ุฑู ฺฉูุฏฺฉุงู ูโุจุงุดุฏ."""

def main():
    """ุชุงุจุน ุงุตู"""
    print("ุดุฑูุน ุงุณุชุฎุฑุงุฌ ูุญุชูุง ฺฉุงูู ุชุตุงูุฑ ุจุง API...")
    print("=" * 60)
    
    result = {
        "images": [],
        "metadata": {
            "extracted_at": datetime.now().isoformat(),
            "total_images": 0,
            "version": "1.0"
        }
    }
    
    # ูพุฏุง ฺฉุฑุฏู ููู ูุงูโูุง ุชุตูุฑ
    image_extensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp']
    image_files = []
    
    for ext in image_extensions:
        image_files.extend(list(CONTENT_DIR.glob(f"*{ext}")))
        image_files.extend(list(CONTENT_DIR.glob(f"*{ext.upper()}")))
    
    # ุญุฐู ุชฺฉุฑุงุฑโูุง
    image_files = list(set(image_files))
    
    print(f"๐ ุชุนุฏุงุฏ ุชุตุงูุฑ ูพุฏุง ุดุฏู: {len(image_files)}")
    print()
    
    # ูพุฑุฏุงุฒุด ูุฑ ุชุตูุฑ
    for i, image_path in enumerate(image_files, 1):
        print(f"๐ผ๏ธ  [{i}/{len(image_files)}] ูพุฑุฏุงุฒุด ุจุง API: {image_path.name}")
        
        try:
            # ูุฑุงุฎูุงู API
            api_result = call_vision_api(image_path)
            
            if api_result["success"]:
                image_data = {
                    "filename": image_path.name,
                    "path": f"Content/{image_path.name}",
                    "file_size_kb": round(image_path.stat().st_size / 1024, 2),
                    "content": api_result["content"],
                    "extracted_at": datetime.now().isoformat()
                }
                result["images"].append(image_data)
                print(f"   โ ูุญุชูุง ุงุณุชุฎุฑุงุฌ ุดุฏ ({len(api_result['content'])} ฺฉุงุฑุงฺฉุชุฑ)")
            else:
                print(f"   โ ุฎุทุง: {api_result.get('error', 'ูุงูุดุฎุต')}")
                
        except Exception as e:
            print(f"   โ ุฎุทุง ุฏุฑ ูพุฑุฏุงุฒุด: {e}")
    
    # ุจูโุฑูุฒุฑุณุงู ุขูุงุฑ
    result["metadata"]["total_images"] = len(result["images"])
    
    # ุฐุฎุฑู ูุงู JSON
    print(f"\n๐พ ุฏุฑ ุญุงู ุฐุฎุฑู ูุงู JSON...")
    with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
        json.dump(result, f, ensure_ascii=False, indent=2)
    
    print("=" * 60)
    print(f"โ ุงุณุชุฎุฑุงุฌ ุจุง ููููุช ุงูุฌุงู ุดุฏ!")
    print(f"\n๐ ุขูุงุฑ ููุง:")
    print(f"   ๐ผ๏ธ  ุชุตุงูุฑ ูพุฑุฏุงุฒุด ุดุฏู: {result['metadata']['total_images']}")
    print(f"\n๐ ูุงู ุฎุฑูุฌ: {OUTPUT_FILE}")
    print("=" * 60)

if __name__ == "__main__":
    main()

